### INITIALIZATION ###
import sys
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import rc
rc("text", usetex=True)
plt.rcParams['font.family'] = 'serif'
plt.rcParams['font.size'] = 16
plt.rcParams['lines.linewidth'] = 2.5
plt.rcParams['figure.figsize'] = (8, 5)
np.set_printoptions(threshold=sys.maxsize)

from Fits import *
from CompassLoader import *

# Code used to analyze the effect of changing some parameters
# of the trapezoid filter in COMPASS

### CODE ###
# Data loading
folder = r"C:\Users\Lucas Garrido\Documents\PhD\Measurements\Trapezoid_tests"
runs = range(1,15)
data = np.zeros((2,4095,14))
for run in runs:
    data[:,:,run-1] = CompassLoader(folder + "\HcompassF_run_" + str(run) + "_20220316.root")

ref = np.loadtxt(folder + "/triple_alpha.txt")              # this is the spectrum i emulated

# Analysis of each run
params = []
R = []
for run in runs:
    fit = Gaussian_fit_spectra(data[0,:,run-1], data[1,:,run-1], plot=False)
    params.append(fit)
    R.append(fit.get("R[%]"))

# ref_fit = Gaussian_fit_spectra(range(len(ref)), ref, plot=False)    # solo funciona cambiando en Fits.py el y/2

# Plots
# Reference plot
plt.step(range(len(ref)), ref, color="tab:blue")
plt.fill_between(range(len(ref)), ref, color="tab:blue", step="pre")
plt.plot(range(len(ref)), Gaussian(range(len(ref)), ref_fit.get("amplitude")[0,0], ref_fit.get("mean")[0,0], ref_fit.get("sigma")[0,0]), color="tab:red")
plt.plot(range(len(ref)), Gaussian(range(len(ref)), ref_fit.get("amplitude")[1,0], ref_fit.get("mean")[1,0], ref_fit.get("sigma")[1,0]), color="tab:red")
plt.plot(range(len(ref)), Gaussian(range(len(ref)), ref_fit.get("amplitude")[2,0], ref_fit.get("mean")[2,0], ref_fit.get("sigma")[2,0]), color="tab:red")
plt.text(537, 1500, str(round(ref_fit.get("R[%]")[0,0],2)) + "\%")
plt.text(564, 1600, str(round(ref_fit.get("R[%]")[1,0],2)) + "\%")
plt.text(591, 650, str(round(ref_fit.get("R[%]")[2,0],2)) + "\%")
plt.xlabel("ADC Channel")
plt.ylabel("Counts")
plt.title("Simulated spectrum")
plt.xlim(520,600)
plt.ylim(0)
plt.show()

# Changing rise time (runs 1 - 3)
f, ax = plt.subplots(1, 3, figsize=(16,8))
ax[0].step(data[0,:,0], data[1,:,0], color="tab:blue")
ax[0].plot(data[0,:,0], Gaussian(data[0,:,0], params[0].get("amplitude")[0,0], params[0].get("mean")[0,0], params[0].get("sigma")[0,0]), color="tab:red")
ax[0].plot(data[0,:,0], Gaussian(data[0,:,0], params[0].get("amplitude")[1,0], params[0].get("mean")[1,0], params[0].get("sigma")[1,0]), color="tab:red")
ax[0].plot(data[0,:,0], Gaussian(data[0,:,0], params[0].get("amplitude")[2,0], params[0].get("mean")[2,0], params[0].get("sigma")[2,0]), color="tab:red")
ax[0].fill_between(data[0,:,0], data[1,:,0], color="tab:blue", step="pre")
ax[0].text(357, 35000, str(round(R[0][0][0],2)) + "\%")
ax[0].text(375, 30000, str(round(R[0][1][0],2)) + "\%")
ax[0].text(393, 12000, str(round(R[0][2][0],2)) + "\%")
ax[1].step(data[0,:,1], data[1,:,1], color="tab:blue")
ax[1].plot(data[0,:,1], Gaussian(data[0,:,1], params[1].get("amplitude")[0,0], params[1].get("mean")[0,0], params[1].get("sigma")[0,0]), color="tab:red")
ax[1].plot(data[0,:,1], Gaussian(data[0,:,1], params[1].get("amplitude")[1,0], params[1].get("mean")[1,0], params[1].get("sigma")[1,0]), color="tab:red")
ax[1].plot(data[0,:,1], Gaussian(data[0,:,1], params[1].get("amplitude")[2,0], params[1].get("mean")[2,0], params[1].get("sigma")[2,0]), color="tab:red")
ax[1].fill_between(data[0,:,1], data[1,:,1], color="tab:blue", step="pre")
ax[1].text(252, 4100, str(round(R[1][0][0],2)) + "\%")
ax[1].text(265, 3000, str(round(R[1][1][0],2)) + "\%")
ax[1].text(280, 1200, str(round(R[1][2][0],2)) + "\%")
ax[2].step(data[0,:,2], data[1,:,2], color="tab:blue")
ax[2].fill_between(data[0,:,2], data[1,:,2], color="tab:blue", step="pre")
ax[2].plot(data[0,:,2], Gaussian(data[0,:,2], params[2].get("amplitude")[0,0], params[2].get("mean")[0,0], params[2].get("sigma")[0,0]), color="tab:red")
ax[2].plot(data[0,:,2], Gaussian(data[0,:,2], params[2].get("amplitude")[1,0], params[2].get("mean")[1,0], params[2].get("sigma")[1,0]), color="tab:red")
ax[2].plot(data[0,:,2], Gaussian(data[0,:,2], params[2].get("amplitude")[2,0], params[2].get("mean")[2,0], params[2].get("sigma")[2,0]), color="tab:red")
ax[2].text(186, 2900, str(round(R[2][0][0],2)) + "\%")
ax[2].text(196, 1800, str(round(R[2][1][0],2)) + "\%")
ax[2].text(206, 650, str(round(R[2][2][0],2)) + "\%")
ax[0].set_xlim(300,420)
ax[1].set_xlim(200,320)
ax[2].set_xlim(140,260)
ax[0].set_ylim(0)
ax[1].set_ylim(0)
ax[2].set_ylim(0)
ax[0].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[2].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0].set_ylabel("Counts")
ax[0].set_xlabel("ADC Channel")
ax[1].set_xlabel("ADC Channel")
ax[2].set_xlabel("ADC Channel")
ax[0].set_title("Rise time = 0.016 $\mu$s")
ax[1].set_title("Rise time = 0.032 $\mu$s")
ax[2].set_title("Rise time = 0.064 $\mu$s")
plt.suptitle("Runs 1-3")

# Changing flat top (runs 4 - 9)
f, ax = plt.subplots(2, 3, figsize=(16,8))
ax[0,0].step(data[0,:,3], data[1,:,3], color="tab:blue")
ax[0,0].plot(data[0,:,3], Gaussian(data[0,:,3], params[3].get("amplitude")[0,0], params[3].get("mean")[0,0], params[3].get("sigma")[0,0]), color="tab:red")
ax[0,0].plot(data[0,:,3], Gaussian(data[0,:,3], params[3].get("amplitude")[1,0], params[3].get("mean")[1,0], params[3].get("sigma")[1,0]), color="tab:red")
ax[0,0].plot(data[0,:,3], Gaussian(data[0,:,3], params[3].get("amplitude")[2,0], params[3].get("mean")[2,0], params[3].get("sigma")[2,0]), color="tab:red")
ax[0,0].fill_between(data[0,:,3], data[1,:,3], color="tab:blue", step="pre")
ax[0,0].set_ylim(0)
ax[0,0].set_xlim(300,420)
ax[0,0].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0,0].set_ylabel("Counts")
ax[0,0].set_title("Flat top = 0.496 $\mu$s")
ax[0,1].step(data[0,:,4], data[1,:,4], color="tab:blue")
ax[0,1].plot(data[0,:,4], Gaussian(data[0,:,4], params[4].get("amplitude")[0,0], params[4].get("mean")[0,0], params[4].get("sigma")[0,0]), color="tab:red")
ax[0,1].plot(data[0,:,4], Gaussian(data[0,:,4], params[4].get("amplitude")[1,0], params[4].get("mean")[1,0], params[4].get("sigma")[1,0]), color="tab:red")
ax[0,1].plot(data[0,:,4], Gaussian(data[0,:,4], params[4].get("amplitude")[2,0], params[4].get("mean")[2,0], params[4].get("sigma")[2,0]), color="tab:red")
ax[0,1].fill_between(data[0,:,4], data[1,:,4], color="tab:blue", step="pre")
ax[0,1].set_ylim(0)
ax[0,1].set_xlim(300,420)
ax[0,1].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0,1].set_ylabel("Counts")
ax[0,1].set_title("Flat top = 0.192 $\mu$s")
ax[0,2].step(data[0,:,5], data[1,:,5], color="tab:blue")
ax[0,2].plot(data[0,:,5], Gaussian(data[0,:,5], params[5].get("amplitude")[0,0], params[5].get("mean")[0,0], params[5].get("sigma")[0,0]), color="tab:red")
ax[0,2].plot(data[0,:,5], Gaussian(data[0,:,5], params[5].get("amplitude")[1,0], params[5].get("mean")[1,0], params[5].get("sigma")[1,0]), color="tab:red")
ax[0,2].plot(data[0,:,5], Gaussian(data[0,:,5], params[5].get("amplitude")[2,0], params[5].get("mean")[2,0], params[5].get("sigma")[2,0]), color="tab:red")
ax[0,2].fill_between(data[0,:,5], data[1,:,5], color="tab:blue", step="pre")
ax[0,2].set_ylim(0)
ax[0,2].set_xlim(300,420)
ax[0,2].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0,2].set_ylabel("Counts")
ax[0,2].set_title("Flat top = 0.064 $\mu$s")
ax[1,0].step(data[0,:,6], data[1,:,6], color="tab:blue")
ax[1,0].plot(data[0,:,6], Gaussian(data[0,:,6], params[6].get("amplitude")[0,0], params[6].get("mean")[0,0], params[6].get("sigma")[0,0]), color="tab:red")
ax[1,0].plot(data[0,:,6], Gaussian(data[0,:,6], params[6].get("amplitude")[1,0], params[6].get("mean")[1,0], params[6].get("sigma")[1,0]), color="tab:red")
ax[1,0].plot(data[0,:,6], Gaussian(data[0,:,6], params[6].get("amplitude")[2,0], params[6].get("mean")[2,0], params[6].get("sigma")[2,0]), color="tab:red")
ax[1,0].fill_between(data[0,:,6], data[1,:,6], color="tab:blue", step="pre")
ax[1,0].set_ylim(0)
ax[1,0].set_xlim(270,420)
ax[1,0].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1,0].set_ylabel("Counts")
ax[1,0].set_xlabel("ADC Channel")
ax[1,0].set_title("Flat top = 0.016 $\mu$s")
ax[1,1].step(data[0,:,7], data[1,:,7], color="tab:blue")
ax[1,1].plot(data[0,:,7], Gaussian(data[0,:,7], params[7].get("amplitude")[0,0], params[7].get("mean")[0,0], params[7].get("sigma")[0,0]), color="tab:red")
ax[1,1].plot(data[0,:,7], Gaussian(data[0,:,7], params[7].get("amplitude")[1,0], params[7].get("mean")[1,0], params[7].get("sigma")[1,0]), color="tab:red")
ax[1,1].plot(data[0,:,7], Gaussian(data[0,:,7], params[7].get("amplitude")[2,0], params[7].get("mean")[2,0], params[7].get("sigma")[2,0]), color="tab:red")
ax[1,1].fill_between(data[0,:,7], data[1,:,7], color="tab:blue", step="pre")
ax[1,1].set_ylim(0)
ax[1,1].set_xlim(200,290)
ax[1,1].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1,1].set_ylabel("Counts")
ax[1,1].set_xlabel("ADC Channel")
ax[1,1].set_title("Flat top = 0.016 $\mu$s")
ax[1,2].step(data[0,:,8], data[1,:,8], color="tab:blue")
ax[1,2].plot(data[0,:,8], Gaussian(data[0,:,8], params[8].get("amplitude")[0,0], params[8].get("mean")[0,0], params[8].get("sigma")[0,0]), color="tab:red")
ax[1,2].plot(data[0,:,8], Gaussian(data[0,:,8], params[8].get("amplitude")[1,0], params[8].get("mean")[1,0], params[8].get("sigma")[1,0]), color="tab:red")
ax[1,2].plot(data[0,:,8], Gaussian(data[0,:,8], params[8].get("amplitude")[2,0], params[8].get("mean")[2,0], params[8].get("sigma")[2,0]), color="tab:red")
ax[1,2].fill_between(data[0,:,8], data[1,:,8], color="tab:blue", step="pre")
ax[1,2].set_ylim(0)
ax[1,2].set_xlim(300,420)
ax[1,2].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1,2].set_ylabel("Counts")
ax[1,2].set_xlabel("ADC Channel")
ax[1,2].set_title("Flat top = 2 $\mu$s")
ax[0,0].text(355, 3200, str(round(R[3][0][0],2)) + "\%")
ax[0,0].text(375, 2200, str(round(R[3][1][0],2)) + "\%")
ax[0,0].text(393, 1000, str(round(R[3][2][0],2)) + "\%")
ax[0,1].text(355, 3400, str(round(R[4][0][0],2)) + "\%")
ax[0,1].text(375, 2200, str(round(R[4][1][0],2)) + "\%")
ax[0,1].text(393, 1000, str(round(R[4][2][0],2)) + "\%")
ax[0,2].text(355, 3400, str(round(R[5][0][0],2)) + "\%")
ax[0,2].text(375, 2200, str(round(R[5][1][0],2)) + "\%")
ax[0,2].text(393, 1000, str(round(R[5][2][0],2)) + "\%")
ax[1,0].text(355, 4000, str(round(R[6][0][0],2)) + "\%")
ax[1,0].text(375, 2500, str(round(R[6][1][0],2)) + "\%")
ax[1,0].text(393, 1000, str(round(R[6][2][0],2)) + "\%")
ax[1,1].text(252, 4000, str(round(R[7][0][0],2)) + "\%")
ax[1,1].text(265, 2500, str(round(R[7][1][0],2)) + "\%")
ax[1,1].text(277, 1000, str(round(R[7][2][0],2)) + "\%")
ax[1,2].text(355, 4000, str(round(R[8][0][0],2)) + "\%")
ax[1,2].text(375, 2500, str(round(R[8][1][0],2)) + "\%")
ax[1,2].text(393, 1000, str(round(R[8][2][0],2)) + "\%")
plt.suptitle("Runs 4-9")

# Changing peaking time (run 10)
f = plt.figure(figsize=(16,8))
plt.step(data[0,:,9], data[1,:,9], color="tab:blue")
plt.fill_between(data[0,:,9], data[1,:,9], color="tab:blue", step="pre")
plt.xlabel("ADC Channel")
plt.ylabel("Counts")
plt.ylim(0)
plt.xlim(175,290)
plt.title("Run 10\n Peaking time 4.8\%")

# Changing energy fine gain (runs 11 - 14)
f, ax = plt.subplots(2, 2, figsize=(16,8))
ax[0,0].step(data[0,:,10], data[1,:,10], color="tab:blue")
ax[0,0].plot(data[0,:,10], Gaussian(data[0,:,10], params[10].get("amplitude")[0,0], params[10].get("mean")[0,0], params[10].get("sigma")[0,0]), color="tab:red")
ax[0,0].plot(data[0,:,10], Gaussian(data[0,:,10], params[10].get("amplitude")[1,0], params[10].get("mean")[1,0], params[10].get("sigma")[1,0]), color="tab:red")
ax[0,0].plot(data[0,:,10], Gaussian(data[0,:,10], params[10].get("amplitude")[2,0], params[10].get("mean")[2,0], params[10].get("sigma")[2,0]), color="tab:red")
ax[0,0].fill_between(data[0,:,10], data[1,:,10], color="tab:blue", step="pre")
ax[0,0].set_ylim(0)
ax[0,0].set_xlim(300,420)
ax[0,0].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0,0].set_ylabel("Counts")
ax[0,0].set_title("Energy fine gain = 1")
ax[0,1].step(data[0,:,11], data[1,:,11], color="tab:blue")
ax[0,1].plot(data[0,:,11], Gaussian(data[0,:,11], params[11].get("amplitude")[0,0], params[11].get("mean")[0,0], params[11].get("sigma")[0,0]), color="tab:red")
ax[0,1].plot(data[0,:,11], Gaussian(data[0,:,11], params[11].get("amplitude")[1,0], params[11].get("mean")[1,0], params[11].get("sigma")[1,0]), color="tab:red")
ax[0,1].plot(data[0,:,11], Gaussian(data[0,:,11], params[11].get("amplitude")[2,0], params[11].get("mean")[2,0], params[11].get("sigma")[2,0]), color="tab:red")
ax[0,1].fill_between(data[0,:,11], data[1,:,11], color="tab:blue", step="pre")
ax[0,1].set_ylim(0)
ax[0,1].set_xlim(1250,1600)
ax[0,1].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[0,1].set_ylabel("Counts")
ax[0,1].set_title("Energy fine gain = 4")
ax[1,0].step(data[0,:,12], data[1,:,12], color="tab:blue")
ax[1,0].plot(data[0,:,12], Gaussian(data[0,:,12], params[12].get("amplitude")[0,0], params[12].get("mean")[0,0], params[12].get("sigma")[0,0]), color="tab:red")
ax[1,0].plot(data[0,:,12], Gaussian(data[0,:,12], params[12].get("amplitude")[1,0], params[12].get("mean")[1,0], params[12].get("sigma")[1,0]), color="tab:red")
ax[1,0].plot(data[0,:,12], Gaussian(data[0,:,12], params[12].get("amplitude")[2,0], params[12].get("mean")[2,0], params[12].get("sigma")[2,0]), color="tab:red")
ax[1,0].fill_between(data[0,:,12], data[1,:,12], color="tab:blue", step="pre")
ax[1,0].set_ylim(0)
ax[1,0].set_xlim(1900,2400)
ax[1,0].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1,0].set_ylabel("Counts")
ax[1,0].set_title("Energy fine gain = 6")
ax[1,1].step(data[0,:,13], data[1,:,13], color="tab:blue")
ax[1,1].plot(data[0,:,13], Gaussian(data[0,:,13], params[13].get("amplitude")[0,0], params[13].get("mean")[0,0], params[13].get("sigma")[0,0]), color="tab:red")
ax[1,1].plot(data[0,:,13], Gaussian(data[0,:,13], params[13].get("amplitude")[1,0], params[13].get("mean")[1,0], params[13].get("sigma")[1,0]), color="tab:red")
ax[1,1].plot(data[0,:,13], Gaussian(data[0,:,13], params[13].get("amplitude")[2,0], params[13].get("mean")[2,0], params[13].get("sigma")[2,0]), color="tab:red")
ax[1,1].fill_between(data[0,:,13], data[1,:,13], color="tab:blue", step="pre")
ax[1,1].set_ylim(0)
ax[1,1].set_xlim(2800,3550)
ax[1,1].ticklabel_format(axis="y", style="sci", scilimits=(3,3))
ax[1,1].set_ylabel("Counts")
ax[1,1].set_title("Energy fine gain = 9")
ax[0,0].text(353, 6300, str(round(R[10][0][0],2)) + "\%")
ax[0,0].text(372, 5000, str(round(R[10][1][0],2)) + "\%")
ax[0,0].text(390, 2000, str(round(R[10][2][0],2)) + "\%")
ax[0,1].text(1410, 2000, str(round(R[11][0][0],2)) + "\%")
ax[0,1].text(1480, 1500, str(round(R[11][1][0],2)) + "\%")
ax[0,1].text(1550, 800, str(round(R[11][2][0],2)) + "\%")
ax[1,0].text(2120, 2200, str(round(R[12][0][0],2)) + "\%")
ax[1,0].text(2220, 1900, str(round(R[12][1][0],2)) + "\%")
ax[1,0].text(2320, 900, str(round(R[12][2][0],2)) + "\%")
ax[1,1].text(3170, 1500, str(round(R[13][0][0],2)) + "\%")
ax[1,1].text(3320, 1300, str(round(R[13][1][0],2)) + "\%")
ax[1,1].text(3480, 600, str(round(R[13][2][0],2)) + "\%")
plt.suptitle("Runs 11-14")

# Bar plot
resolutions = []
i = 0
while i < 3:
    resolutions.append([R[0][i][0], R[1][i][0], R[2][i][0], R[3][i][0], R[4][i][0], R[5][i][0], R[6][i][0], R[7][i][0], R[8][i][0], R[10][i][0], R[11][i][0], R[12][i][0], R[13][i][0]])
    i = i + 1

x = [str(1),str(2),str(3),str(4),str(5),str(6),str(7),str(9),str(10),str(11),str(12),str(13),str(14)]
aux = np.arange(13)

f = plt.figure(figsize=(16,8))
plt.bar(aux, resolutions[0], color="tab:blue", width=0.2, label="Peak 1")
plt.bar(aux + 0.25, resolutions[1], color="tab:red", width=0.2, label="Peak 2")
plt.bar(aux + 0.5, resolutions[2], color="tab:green", width=0.2, label="Peak 3")
plt.xlabel("\# run")
plt.ylabel("Resolution (\%)")
plt.ylim(1,3.6)
plt.xticks( aux + 0.25 , x)
plt.legend()
plt.title("Peak resolution for each run")
plt.show()